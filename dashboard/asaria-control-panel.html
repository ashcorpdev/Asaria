<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../dashboard/css/mystyles.css" />
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"
    ></script>
    <style>
      .monospace {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
		<section class="hero" id="main-header">
				<div class="hero-body">
				  <div class="container">
					<h1 class="title has-text-centered control-header">
					  Asaria
					</h1>
					<h2 class="subtitle is-3 has-text-centered control-subtitle">
					  Control Panel
					</h2>
				  </div>
				</div>
			  </section>
    <section class="section" style="padding: 1.5rem 1.5rem">
      <div class="container">
		  <nav class="level box" id="team-status">
				<div class="level-item has-text-centered"><div><p class="heading">Red</p><p class="title">
						<span id="red"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Yellow</p><p class="title">
					<span id="yellow"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Pink</p><p class="title">
						<span id="pink"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Green</p><p class="title">
						<span id="green"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Orange</p><p class="title">
						<span id="orange"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Purple</p><p class="title">
						<span id="purple"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Blue</p><p class="title">
						<span id="blue"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">White</p><p class="title">
						<span id="white"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Grey</p><p class="title">
						<span id="grey"></span>
				</p></div></div>
				<div class="is-divider-vertical"></div><div class="level-item has-text-centered"><div><p class="heading">Black</p><p class="title">
						<span id="black"></span>
					</div>
		  </nav>
        </p>
	  </div>
	</section>
	<section class="section">
			<div id="container">
					<div class="tile is-ancestor">
							<div class="tile is-6 is-parent">
								<div class="tile is-child box">
										<p class="title has-text-centered">Manage </p>
										<div class="columns">
												<div class="column">
													<div class="field">
															<p class="control"><div class="select">
																	<select id="teamSelection">
																				<option value="choose">Choose team</option>
																				<option value="red">Red</option>
																				<option value="yellow">Yellow</option>
																				<option value="pink">Pink</option>
																				<option value="green">Green</option>
																				<option value="orange">Orange</option>
																				<option value="purple">Purple</option>
																				<option value="blue">Blue</option>
																				<option value="white">White</option>
																				<option value="grey">Grey</option>
																				<option value="black">Black</option>
																			  </select>
																		</div></p></div>
																		<p class="control">
																				<div class="field">
																						<input class="input" type="text" placeholder="Set value" id="valueInput">
																					</div></p>
																	<div class="field is-grouped">
																		<p class="control">
																				<button class="button is-primary" id="add-button">Add</button></p>
																			<p class="control"><button class="button is-danger" id="remove-button">Remove</button></p>
																		</div>
												</div>
												<div class="column">
													<p class="control"><div class="field">
															<input id="hypetrain" type="checkbox" name="hypetrain" class="switch is-rounded" checked="checked" disabled>
															<label for="hypetrain">???</label>
													</div></p>
													<p class="control">
															<div class="field">
																	<input id="bonuspoints" type="checkbox" name="bonuspoints" class="switch is-rounded" checked="checked" disabled>
																	<label for="bonuspoints">???</label>
															</div></p>
														
														<p class="control"><div class="field">
																<input id="hypetrain" type="checkbox" name="hypetrain" class="switch is-rounded" checked="checked" disabled>
																<label for="hypetrain">???</label>
														</div></p>
														<p class="control">
																<div class="field">
																		<input id="bonuspoints" type="checkbox" name="bonuspoints" class="switch is-rounded" checked="checked" disabled>
																		<label for="bonuspoints">???</label>
																</div></p><p class="control"><div class="field">
																		<input id="hypetrain" type="checkbox" name="hypetrain" class="switch is-rounded" checked="checked" disabled>
																		<label for="hypetrain">???</label>
																</div></p>
																<p class="control">
																		<div class="field">
																				<input id="bonuspoints" type="checkbox" name="bonuspoints" class="switch is-rounded" checked="checked" disabled>
																				<label for="bonuspoints">???</label>
																		</div></p>
															</div>
								</div>
							</div>
						</div>
							<div class="tile is-6 is-parent">
								<div class="tile is-child box">
								   <h1 class="title has-text-centered">
										   Event List
										 </h1>
										 <h2 class="subtitle has-text-centered">
											 <div class="notification">
													<i class="fas fa-star"></i>
													<strong>Recent Subscription:</strong> <span id="latestSubscription">kaypowxd subscribed for 11 months.</span>
												  </div>
												  <div class="notification">
														<i class="fas fa-gem"></i>
														<strong>Recent Cheer:</strong> <span id="latestCheer">bochicchio cheered 1000 bits.</span>
													  </div>
													  <div class="notification">
															<i class="fas fa-coins"></i>
															<strong>Recent Tip:</strong> <span id="latestDonation">lordrevanheart tipped 10 USD.</span>
														  </div>
										 </h2>
									</div>
								   </div>
			</div>
		</div>
	</section>
	<footer class="footer" style="padding: 1rem 0.5rem 1rem;">
			<div class="content has-text-centered">
			  <p>
				<strong>Asaria</strong> developed by <a href="https://ashen.live">Ashen</a>.
			  </p>
			</div>
		  </footer>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"
      type="text/javascript"
    ></script>
    <script type="text/javascript">
      const socketToken =
        "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbiI6IjNGM0ZCRUQyMEQ2N0EwNDEyNzI5IiwicmVhZF9vbmx5Ijp0cnVlLCJwcmV2ZW50X21hc3RlciI6dHJ1ZSwidHdpdGNoX2lkIjoiODg0ODY3NjcifQ.dXCDrfNSi-SF1ZgHIZSc-Z4gq2LTcUqlmiq0hSNW_2w";
      //Connect to socket
      const streamlabs = io(
        `https://sockets.streamlabs.com?token=${socketToken}`,
        { transports: ["websocket"] }
      );

      const latestDonation = nodecg.Replicant("latestDonation");
      const latestCheer = nodecg.Replicant("latestCheer");
      const latestSubscription = nodecg.Replicant("latestSubscription");
	  const teamPoints = nodecg.Replicant("teamPoints");
	  const addButton = document.getElementById('add-button');
	  const removeButton = document.getElementById('remove-button');
	  const valueInput = document.getElementById('valueInput');
	  const teamSelection = document.getElementById('teamSelection');

      teamPoints.on("change", (newValue, oldValue) => {
        console.log(`teamPoints changed from ${oldValue} to ${newValue}`);
        console.log(JSON.stringify(newValue));
        var red = document.getElementById("red");
        var yellow = document.getElementById("yellow");
        var pink = document.getElementById("pink");
        var green = document.getElementById("green");
        var orange = document.getElementById("orange");
        var purple = document.getElementById("purple");
        var blue = document.getElementById("blue");
        var white = document.getElementById("white");
        var grey = document.getElementById("grey");
        var black = document.getElementById("black");
		red.innerHTML = newValue.red;
		yellow.innerHTML = newValue.yellow;
		pink.innerHTML = newValue.pink;
		green.innerHTML = newValue.green;
		orange.innerHTML = newValue.orange;
		purple.innerHTML = newValue.purple;
		blue.innerHTML = newValue.blue;
		white.innerHTML = newValue.white;
		grey.innerHTML = newValue.grey;
		black.innerHTML = newValue.black;
      });

      latestDonation.on("change", (newValue, oldValue) => {
        console.log(`latestDonation changed from ${oldValue} to ${newValue}`);
		console.log(JSON.stringify(newValue));
		var donationText = document.getElementById('latestDonation');
		donationText.innerHTML = newValue.name + " donated Â£" + newValue.amount + ".";
      });

      latestCheer.on("change", (newValue, oldValue) => {
        console.log(`latestCheer changed from ${oldValue} to ${newValue}`);
        console.log(JSON.stringify(newValue));
		var cheerText = document.getElementById('latestCheer');
		cheerText.innerHTML = newValue.name + " cheered " + newValue.amount + " bits.";
      });

      latestSubscription.on("change", (newValue, oldValue) => {
        console.log(
          `latestSubscription changed from ${oldValue} to ${newValue}`
        );
        console.log(JSON.stringify(newValue));
		var subscriptionText = document.getElementById('latestSubscription');
		subscriptionText.innerHTML = newValue.name + " subscribed for " + newValue.months + " months.";
      });
      //Perform Action on event
      streamlabs.on("event", eventData => {
        if (eventData.for === "streamlabs" && eventData.type === "donation") {
          //code to handle donation events
          console.log(eventData.message);
          nodecg.log.info(
            "Donation alert: " + eventData.message[0].name,
            eventData.message[0].amount,
            eventData.message[0].currency
          );

          // Reduce characters at end of amount
          let amounts = eventData.message[0].amount;
          let newamount = amounts.substring(0, amounts.length - 8);
          latestDonation.value = {
            name: eventData.message[0].name,
            amount: newamount,
            currency: eventData.message[0].currency
          };
        }
        if (eventData.for === "twitch_account") {
          switch (eventData.type) {
            case "follow":
              //code to handle follow events
              console.log(eventData.message);
              break;
            case "subscription":
              //code to handle subscription events
              console.log(eventData.message);
              nodecg.log.info(
                "Subscription alert: " + eventData.message[0].name,
                eventData.message[0].months,
                eventData.message[0].sub_plan
              );
              latestSubscription.value = {
                name: eventData.message[0].name,
                sub_plan: eventData.message[0].sub_plan,
                months: eventData.message[0].months,
                gifter: eventData.message[0].gifter
              };
              break;
            case "bits":
              //code to handle donation events
              console.log(eventData.message);
              nodecg.log.info(
                "Cheer alert: " + eventData.message[0].name,
                eventData.message[0].amount
              );
              latestCheer.value = {
                name: eventData.message[0].name,
                amount: eventData.message[0].amount
              };

              break;
            default:
              //default case
              console.log(eventData.message);
          }
        }
      });
	
	  addButton.addEventListener("click", function() {
		  updateTeams("add", valueInput.value)
	  });
	  removeButton.addEventListener("click", function() {
		updateTeams("remove", valueInput.value)
	  });

	  function updateTeams(option, amount){
		if(teamSelection.value == "choose"){
			console.log("Choose a team!");
		}else {
			let selected = teamSelection.value;
			if(option == "add"){
				let currentPoints = Number(document.getElementById(selected).innerText);
				let newPoints = parseInt(currentPoints,10) + parseInt(valueInput.value,10);
				console.log(parseInt(newPoints, 10));
				let updatedPoints = parseInt(newPoints, 10);
				nodecg.sendMessage('updateCount', { updatedPoints, selected })
				.then(result => {
					console.log('Values updated!');
				}).catch(error => {
				console.error(error);
				});
			}else if(option == "remove"){

				let currentPoints = Number(document.getElementById(selected).innerText);
				let newPoints = parseInt(currentPoints, 10) - parseInt(valueInput.value, 10);
				console.log(parseInt(newPoints, 10));
				let updatedPoints = parseInt(newPoints, 10);
				if(updatedPoints <= 0){
					updatedPoints = 0;
				}
				nodecg.sendMessage('updateCount', { updatedPoints, selected })
				.then(result => {
					console.log('Values updated!');
				}).catch(error => {
				console.error(error);
				});
			}else{

			}
		}
	  }
	
	  </script>
  </body>
</html>
